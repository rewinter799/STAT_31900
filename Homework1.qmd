---
title: "STAT 31900 --- Assignment 1: \n\n Causal Inference Theories and Applications"
author: "Robert Winter"
format: pdf
editor: visual

highlight-style: pygments
geometry:
      - top=30mm
      - left=30mm
toc: true
toc-title: Table of Contents
number-sections: true

# Suppress output for assignments
echo: false
warning: false

# Wrap code chunk text
include-in-header:
  text: |
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
    
# bibliography: references.bib
---

# Introduction

*Throughout this document, **bolded** language signifies the problem set's instructions. My responses are provided in non-bold text.*

```{r}
#\ warning: false
library(haven)
library(dplyr)
```

## Context

**All three assignments in this class are organized around investigations of the causal effect of class size reduction on student learning. The data for this first assignment came from a randomized experiment conducted in the State of Tennessee in 1985. Within each of the 76 participating schools, students entering kindergarten were assigned at random to one of three class types: a small class designed to have an enrollment range of 13–17 students; a regular class with an enrollment of 22–25 students; or a regular class with a teaching aide. Teachers were assigned at random to classes as well. Students were expected to remain in their initially assigned treatment conditions for four years. New teachers were assigned at random to classes in each subsequent grade. Students who did not attend kindergarten in the participating schools were randomized to different class types when they joined the study from the beginning of grade 1. Because past research has found no distinction in effectiveness between “regular class” and “regular class with a teaching aide,” these are combined into one category.**

**More background information about this study and access to the entire data set can be found on this website: <https://dataverse.harvard.edu/dataset.xhtml?persistentId=hdl:1902.1/10766>.**

**Please find on Canvas a subset of the original Project STAR (Student-Teacher Achievement Ratio) data for this assignment. Please restrict the analysis to the 6,258 students who had valid information about treatment group membership in grade 1. This subsample includes the 2,313 students who joined the study in grade 1.**

```{r}
# Load raw dataset
raw_data = read_dta("C:/Users/rewin/OneDrive/Documents/STAT_31900/CHDV 30102 webstar_Winter2024.dta")
```

```{r}
# Data cleaning
data = raw_data %>%
  filter(star1 == 1) # Filter to just students in Project STAR classes in grade 1

# table(data$stark)
# 2,313 students were in STAR classes in grade 1 but NOT in grade K
```

## Notation

**You may use** $Z_k=0, 1$ **to denote the treatment assignment in kindergarten to a small class or a regular class, respectively, and use** $Z_F=0, 1$ **for the corresponding treatment assignment in Grade 1; use** $Y_K$ **to denote the kindergarten math score and** $Y_F$ **for the Grade 1 math score.**

**Please generate a binary indicator** $R$ **that takes value** $1$ **if a kindergartner did not have the Grade-1 math score** $Y_F$**; let** $R=0$ **if a kindergartner had a valid Grade-1 math score.**

```{r}
data = data %>%
  mutate(R = ifelse(tmathss1 == 999, 1, 0)) # assume "scores" of 999 are invalid
```

## Research Questions

**In this assignment, you are asked to evaluate two causal effects:**

1.  ***Research Question 1*****: What is the causal effect of class size reduction in kindergarten (**$Z_K$**) on student *math* achievement by the end of Grade 1 (**$Y_F$**)?**

2.  ***Research Question 2*****: What is the causal effect of class size reduction in Grade 1 (**$Z_F$) **on student *math* achievement by the end of Grade 1 (**$Y_F$)**?**

## Covariates

**Observed baseline covariates include student gender, student race (you may combine Asians, Hispanics, American Indians, and the racial category labeled as “other” into a single category because the number of observations was relatively small for each of these racial/ethnic groups), and student free-lunch status (assuming that a family’s financial situation did not differ between the kindergarten year and the first-grade year). Other covariates of potential interest include Grade 1 teacher career ladder level, and Grade 1 teacher’s teaching experience.**

**In preparation for analysis, please see the [Appendix]{.underline} \[later in\] this assignment for guidance on how to handle missing data in the covariates. (Please briefly explain the necessary steps you have taken in data preparation.)**

```{r}
### RW TO HANDLE MISSING DATA AND DESCRIBE
```

## Data Structure

**Clearly, students were nested in schools and hence those who attended the same school should not be viewed as independent observations. If you have learned multilevel modeling or mixed-effects models in the past, please feel free to go ahead and specify such models (remember to report the robust standard errors). If you do not have such prior knowledge, you may employ OLS regression instead and obtain cluster robust standard errors in Stata or R with clusters indicated by school IDs.**

# Analysis

## General

## Research Question 1 (Questions 2 – 4)

## Research Question 2 (Questions 5 – 10)

## Bonus Questions

**B1. Derive the two sources of selection bias shown in Holland (1986) (see Week 1 Slide 28).**

The bias from estimating the population average treatment effect $\delta$ by the *prima facie* effect $\delta_{PF}$ is given by:

$$
\begin{aligned}
\delta_{PF} - \delta
& = \big(𝔼[Y|Z=1] - 𝔼[Y|Z=0]\big) - \big(𝔼[Y(1)] - 𝔼[Y(0)]\big) \\
& = \big(𝔼[Y(1)|Z=1] - 𝔼[Y(0)|Z=0]\big) - \big(𝔼[Y(1)] - 𝔼[Y(0)]\big) \\
(1) & = 𝔼[Y(1)|Z=1] - 𝔼[Y(0)|Z=0] \\
& \;\;\;\; - \big(\mathrm{P}(Z=0) \cdot 𝔼[Y(1)|Z=0] + \mathrm{P}(Z=1) \cdot 𝔼[Y(1)|Z=1]\big) \\
& \;\;\;\; + \big(\mathrm{P}(Z=0) \cdot 𝔼[Y(0)|Z=0] + \mathrm{P}(Z=1) \cdot 𝔼[Y(0)|Z=1]\big) \\
& = \big(𝔼[Y(1)|Z=1] - \mathrm{P}(Z=1) \cdot 𝔼[Y(1)|Z=1]\big) \\
& \;\;\;\; + \big(-𝔼[Y(0)|Z=0] + \mathrm{P}(Z=0) \cdot 𝔼[Y(0)|Z=0]\big) \\\
& \;\;\;\; - \mathrm{P}(Z=0) \cdot 𝔼[Y(1)|Z=0] + \mathrm{P}(Z=1) \cdot 𝔼[Y(0)|Z=1] \\
& = \big(1 - \mathrm{P}(Z=1)\big) \cdot 𝔼[Y(1)|Z=1] - \big(1 - \mathrm{P}(Z=0)\big) \cdot 𝔼[Y(0)|Z=0] \\
& \;\;\;\; - \mathrm{P}(Z=0) \cdot 𝔼[Y(1)|Z=0] + \mathrm{P}(Z=1) \cdot 𝔼[Y(0)|Z=1] \\
& = \mathrm{P}(Z=0) \cdot 𝔼[Y(1)|Z=1] - \mathrm{P}(Z=1) \cdot 𝔼[Y(0)|Z=0] \\
& \;\;\;\; - \mathrm{P}(Z=0) \cdot 𝔼[Y(1)|Z=0] + \mathrm{P}(Z=1) \cdot 𝔼[Y(0)|Z=1] \\
& = \mathrm{P}(Z=0) \cdot \big(𝔼[Y(1)|Z=1] - 𝔼[Y(1)|Z=0]\big) \\
& \;\;\;\; + \mathrm{P}(Z=1) \cdot \big(𝔼[Y(0)|Z=1] - 𝔼[Y(0)|Z=0]\big) \\
(2) & = \mathrm{P}(Z=0) \cdot \big(𝔼[Y(1)|Z=1] - 𝔼[Y(1)|Z=0]\big) \\
& \;\;\;\; + \mathrm{P}(Z=1) \cdot \big(𝔼[Y(0)|Z=1] - 𝔼[Y(0)|Z=0]\big) \\
& \;\;\;\; + \mathrm{P}(Z=0) \cdot \big(𝔼[Y(0)|Z=1] - 𝔼[Y(0)|Z=0]\big) \\
& \;\;\;\; - \mathrm{P}(Z=0) \cdot \big(𝔼[Y(0)|Z=1] - 𝔼[Y(0)|Z=0]\big) \\
& = \big(\mathrm{P}(Z=1) + \mathrm{P}(Z=0)\big) \cdot \big(𝔼[Y(0)|Z=1] - 𝔼[Y(0)|Z=0]\big) \\
& \;\;\;\; + \mathrm{P}(Z=0) \cdot \big(𝔼[Y(1)|Z=1] - 𝔼[Y(1)|Z=0] - 𝔼[Y(0)|Z=1] + 𝔼[Y(0)|Z=0]\big) \\
(3) & = \big(𝔼[Y(0)|Z=1] - 𝔼[Y(0)|Z=0]\big) \\
& \;\;\;\; + \mathrm{P}(Z=0) \cdot \big(𝔼[Y(1)-Y(0)|Z=1] - 𝔼[Y(1)-Y(0)|Z=0]\big) \\
& = \big(𝔼[Y(0)|Z=1] - 𝔼[Y(0)|Z=0]\big) \\
& \;\;\;\; + \mathrm{P}(Z=0) \cdot \big(𝔼[\Delta|Z=1] - 𝔼[\Delta|Z=0]\big),
\end{aligned}
$$

as desired, where (1) is by the Law of Total Expectation, (2) is by adding 0 in a "peculiar" way, and (3) is by linearity of expectation.

**B2. Prove that each of these two sources of bias will become zero under independence.**

If $Z$ is independent of $Y(0)$ and $Y(1)$, then

$$
\begin{aligned}
& (1) \;\;\; 𝔼[Y(0)] = 𝔼[Y(0)|Z=0] = 𝔼[Y(0)|Z=1], \; \mathrm{and} \\
& (2) \;\;\; 𝔼[Y(1)] = 𝔼[Y(1)|Z=0] = 𝔼[Y(1)|Z=1].
\end{aligned}
$$

Subtracting (1) from (2), we also have

$$
\begin{aligned}
(3) \;\;\; 𝔼[\Delta] = 𝔼[\Delta|Z=0] = 𝔼[\Delta|Z=1].
\end{aligned}
$$

Using (1), our first source of bias (between-group differences in the potential outcome associated with the control condition) is

$$
\begin{aligned}
𝔼[Y(0)|Z=1] - 𝔼[Y(0)|Z=0] = 𝔼[Y(0)] - 𝔼[Y(0)] = 0.
\end{aligned}
$$

Similarly, using (3), our second source of bias (between-group difference in the treatment effect) is

$$
\begin{aligned}
\mathrm{P}(Z=0) \cdot \big(𝔼[\Delta|Z=1] - 𝔼[\Delta|Z=0]\big) = 
\mathrm{P}(Z=0) \cdot \big(𝔼[\Delta] - 𝔼[\Delta]\big) = 0.
\end{aligned}
$$

Thus, both sources of bias become zero under independence of $Z$ and $Y$, as desired.

**B3. Show that when using the *prima facie* causal effect to evaluate the average treatment effect on the treated (ATT), only the first source of bias possibly exists.**

The bias from estimating the average treatment effect on the treated $\mathrm{ATT}$ by the *prima facie* effect $\delta_{PF}$ is given by:

$$
\begin{aligned}
\delta_{PF}-\mathrm{ATT} & = \big(𝔼[Y|Z=1] - 𝔼[Y|Z=0] \big) - 𝔼[Y(1)-Y(0)|Z=1]  \\
& = \big(𝔼[Y(1)|Z=1] - 𝔼[Y(0)|Z=0] \big) - \big(𝔼[Y(1)|Z=1] - 𝔼[Y(0)|Z=1]\big) \\
& = 𝔼[Y(0)|Z=1] - 𝔼[Y(0)|Z=0],
\end{aligned}
$$

which is precisely the form of the first source of bias (between-group difference in the potential outcome associated with the control condition).
